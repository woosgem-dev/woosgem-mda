# schemas/component.schema.yaml
# Component spec schema — merged Layer 0 + Layer 1 for web.
# Defines WHAT a component IS and how it maps to the web platform.
# Aligned with actual spec.yaml vocabulary (2.0.0 alignment update).
# Applies to: specs/*/*/spec.yaml

schema:
  version: 2.0.0
  layer: 0
  description: Component definition — merged semantic source + web platform mapping
  applies_to: specs/*/*/spec.yaml
  note: >
    Schema terminology aligned with actual spec files.
    Specs use web-standard terms (attributes, content, interactions, semantics,
    accessibility, visual_mapping) reflecting the "Accept the Merge" decision
    where spec.yaml = Layer 0 + Layer 1 merged for web components.

# ─────────────────────────────────────────────
# SECTION 1: Required Top-Level Sections
# ─────────────────────────────────────────────

sections:
  component:
    required: true
    fields:
      name: { type: string, required: true, format: PascalCase }
      category: { type: enum, required: true, values: [atom, molecule, organism] }
      description: { type: string, required: true, language: english }
      complexity:
        type: enum
        required: true
        values: [simple, composite, behavioral]
        description: |
          simple — single-unit component with no internal state machine
          composite — sub-components but minimal behavior logic
          behavioral — complex state machine or side effects required
      platforms:
        type: "string[]"
        required: false
        default: [web, ios, android]
        description: "Platforms this component supports. Omit to support all."
      version: { type: string, required: false, format: semver }

  semantics:
    required: true
    description: "HTML semantics — tag and ARIA role for the root element"

  attributes:
    required: true
    description: "Component configuration attributes. Empty {} is valid for components with no configurable attributes."

  content:
    required: true
    description: "Content areas (slots). Empty {} is valid for components with no content."

  states:
    required: true
    description: "Component states. Empty {} is valid for stateless components."

  interactions:
    required: true
    description: "User interactions and their effects. Empty {} is valid for non-interactive components."

  accessibility:
    required: true
    description: "ARIA attributes, keyboard mappings, and focus behavior"

  visual_mapping:
    required: true
    description: "CSS class name and data-attribute mapping strategy for styling hooks"

  # Optional sections
  composition:
    required: false
    description: "Only for compound components with sub-components or external dependencies"

  control:
    required: false
    description: "Only for form components (Input, Select, Checkbox, Radio, Switch, Textarea)"

# ─────────────────────────────────────────────
# SECTION 2: Type Algebra
# ─────────────────────────────────────────────

type_algebra:
  description: "Closed set of allowed types for attributes"

  primitives:
    boolean:
      description: "true or false"
      default_allowed: true
    string:
      description: "Any string value"
      default_allowed: true
      optional_constraints:
        pattern: "Regex pattern"
        format: "Named format (e.g., hex-color)"
    number:
      description: "Numeric value"
      default_allowed: true
      optional_constraints:
        min: "Minimum value"
        max: "Maximum value"
        step: "Step increment"

  constrained:
    enum:
      description: "One of a fixed set of string values"
      requires: [values]
      default_allowed: true
      example:
        type: enum
        values: [filled, outline, ghost, link]
        default: filled

  compound:
    union:
      description: "Multiple types accepted"
      requires: [types]
      example:
        type: union
        types: [string, number]
        default: ~

  special:
    callback:
      description: "Event handler / action closure"
      requires: [signature]
      example:
        type: callback
        signature: "(value: string) => void"

  null_and_undefined:
    description: "Use YAML null (~) for absent defaults. Never use the string 'undefined'."

# ─────────────────────────────────────────────
# SECTION 3: Attribute Definition
# ─────────────────────────────────────────────

attribute_definition:
  fields:
    type: { required: true, values: [enum, boolean, string, number, union] }
    values: { required: "when type=enum" }
    types: { required: "when type=union" }
    default: { required: true, description: "Use ~ (null) if no default" }
    description: { required: true, language: english }
    min: { required: false, applicable: "type=number" }
    max: { required: false, applicable: "type=number" }

# ─────────────────────────────────────────────
# SECTION 4: Content Definition (Slots)
# ─────────────────────────────────────────────

content_definition:
  fields:
    description: { required: true, language: english }
    required: { required: true, type: boolean }
    type:
      required: true
      values: [text, node, component-list]
      description: |
        text — plain text only
        node — any renderable content (text, elements, components)
        component-list — specific component types only (e.g., Tab items)
    cardinality:
      required: false
      values: [single, multiple]
      default: single
    accepts:
      required: false
      description: "List of accepted component names when type=component-list"

# ─────────────────────────────────────────────
# SECTION 5: State Definition
# ─────────────────────────────────────────────

state_definition:
  fields:
    description: { required: false, type: string, language: english }
    visual: { required: true, type: string, language: english }
    behavior: { required: true, type: string, language: english }
    aria:
      required: false
      type: map
      description: "ARIA attribute values in this state"

# ─────────────────────────────────────────────
# SECTION 6: Interaction Definition
# ─────────────────────────────────────────────

interaction_definition:
  description: |
    User interaction definitions using web event trigger names.
    Each interaction maps triggers to an effect with optional conditions.

  fields:
    triggers:
      required: true
      type: "string[]"
      description: "Event trigger names — click, keyboard keys, or custom trigger names"
      common_values:
        - click              # mouse click or tap
        - Enter              # Enter key press
        - Space              # Space key press
        - Escape             # Escape key press
        - Tab                # Tab key press
        - overlay-click      # click on overlay/backdrop area
        - close-button-click # click on close button
    condition:
      required: false
      type: structured
      description: "Machine-parseable condition, not natural language"
      syntax:
        all: "All conditions must be true (AND)"
        any: "At least one must be true (OR)"
        not: "Negation"
      example:
        condition:
          all:
            - { attr: loading, eq: false }
            - { attr: disabled, eq: false }
    effect:
      required: true
      type: enum
      values: [emit, toggle, set]
      description: |
        emit — fires an external callback
        toggle(field) — toggles an internal boolean attribute
        set(field, value) — sets an internal attribute to a value
    payload:
      required: "when effect=emit"
      type: map
      description: "Data emitted with the callback"
    description: { required: true, language: english }

# ─────────────────────────────────────────────
# SECTION 7: Semantics (HTML Tag + ARIA Role)
# ─────────────────────────────────────────────

semantics_definition:
  description: |
    HTML semantics for the root element. Defines the HTML tag and ARIA role.

  fields:
    tag:
      type: string
      required: true
      description: "HTML tag for the root element (e.g., button, div, input, label)"
      common_values: [button, div, span, input, label, a, nav, ul, li, dialog, section]
    role:
      type: enum
      required: true
      values:
        - implicit           # role implied by the HTML tag (e.g., button tag = button role)
        - button
        - link
        - checkbox
        - radio
        - switch
        - textbox
        - listbox
        - option
        - slider
        - tab
        - tabpanel
        - tablist
        - dialog
        - alert
        - alertdialog
        - progressbar
        - separator
        - img
        - none
      description: "ARIA role. Use 'implicit' when the HTML tag already implies the correct role."

# ─────────────────────────────────────────────
# SECTION 8: Accessibility
# ─────────────────────────────────────────────

accessibility_definition:
  description: |
    ARIA attributes, keyboard interaction mappings, focus behavior,
    and live region announcements.

  fields:
    aria:
      required: true
      type: map
      description: "ARIA attribute descriptions keyed by attribute name (e.g., busy, disabled, checked, modal, hidden, labelledby)"
    keyboard:
      required: true
      type: map
      description: "Keyboard key to interaction name mapping (e.g., Enter: activate, Space: toggle, Escape: close)"
    focus:
      required: true
      type: string
      description: "Focus behavior description — how focus ring appears, focusability rules, focus management on state changes"
    live_region:
      required: false
      type: enum
      values: [polite, assertive, off]
      description: "Live region announcement behavior for dynamic content changes"

# ─────────────────────────────────────────────
# SECTION 9: Visual Mapping (CSS Hooks)
# ─────────────────────────────────────────────

visual_mapping_definition:
  description: |
    CSS class name and data-attribute strategy for styling hooks.
    Maps component attributes to data-* attributes using defined strategies.

  fields:
    class:
      required: true
      type: string
      description: "Base CSS class name for the component (e.g., btn, checkbox, modal)"
    data_attributes:
      required: true
      type: map
      description: "Map of data-attribute names to their mapping strategy"
      strategy_types:
        value-mapped:
          description: "data-attribute value directly mirrors the source attribute value"
          requires: [source]
          example:
            data-variant:
              strategy: value-mapped
              source: variant
        present-when-true:
          description: "data-attribute is present (no value) when source boolean is true, absent when false"
          requires: [source]
          example:
            data-full-width:
              strategy: present-when-true
              source: full-width
        priority-enum:
          description: "data-attribute value determined by first matching condition in priority order"
          requires: [priority, fallback]
          example:
            data-state:
              strategy: priority-enum
              priority:
                - { when: { attr: loading, eq: true }, value: loading }
                - { when: { attr: disabled, eq: true }, value: disabled }
              fallback: absent

# ─────────────────────────────────────────────
# SECTION 10: Composition (Compound Components)
# ─────────────────────────────────────────────

composition_definition:
  description: "For components with sub-components."

  fields:
    layout:
      required: true
      type: "string[]"
      description: "Ordered list of sub-component names that defines structure"
      example: [ModalHeader, ModalBody, ModalFooter]

    rendering:
      required: true
      fields:
        strategy:
          type: enum
          values: [inline, overlay, portal]
          description: |
            inline — rendered in document flow
            overlay — rendered above other content
            portal — rendered at document top-level (body) to escape stacking context
        description: { type: string }

    dependencies:
      required: false
      type: map
      description: "External component dependencies by domain"
      example:
        atoms: [Overlay, Spinner]

    communication:
      required: false
      description: "How parent and children share state"
      fields:
        pattern:
          type: enum
          values: [context, events, props]
          description: |
            context — shared state via context/environment (React Context, CompositionLocal, @Environment)
            events — child emits events to parent
            props — parent passes state as props/parameters
        shared_state: { type: "string[]", description: "Attributes shared with children" }

  sub_components:
    description: "Each sub-component is defined inline with its own mini-spec"
    required_fields:
      name: { type: string, format: PascalCase }
      description: { type: string, language: english }
      required: { type: boolean }
    optional_fields:
      tag: "HTML tag for the sub-component"
      attributes: "Same schema as top-level attributes"
      content: "Same schema as top-level content"
      visual_mapping: "Same schema as top-level visual_mapping"
      accessibility: "Same schema as top-level accessibility"

# ─────────────────────────────────────────────
# SECTION 11: Control (Form Components)
# ─────────────────────────────────────────────

control_definition:
  description: "Required for form components: Input, Textarea, Select, Checkbox, Radio, Switch"
  fields:
    mode:
      type: enum
      required: true
      values: [controlled-only, uncontrolled-only, both]
    value:
      required: true
      fields:
        type: { required: true }
        description: { required: true }
    default_value:
      required: "when mode=both or mode=uncontrolled-only"
      fields:
        type: { required: true }
        description: { required: true }
    on_change:
      required: true
      fields:
        payload: { required: true, type: map }
        description: { required: true }

# ─────────────────────────────────────────────
# SECTION 12: Language & Style Rules
# ─────────────────────────────────────────────

language_rules:
  all_text: english
  description_style: noun-phrase
  description_examples:
    good: "Primary interaction button with multiple visual variants and states"
    bad: "This is a button that can be used for primary interactions"
  no_ambiguous_words: ["usually", "sometimes", "might", "can be", "etc."]
  null_convention: "Use YAML null (~) for absent values. Never 'undefined' string."

# ─────────────────────────────────────────────
# SECTION 13: Validation Checklist
# ─────────────────────────────────────────────

validation_checklist:
  errors:
    - All required sections present (component, semantics, attributes, content, states, interactions, accessibility, visual_mapping)
    - All attribute types from closed type algebra
    - All interaction conditions use structured syntax (not natural language)
    - All interactions with effect=emit have payload defined
    - Semantic tag is a valid HTML element
    - Semantic role is from allowed values list (or 'implicit')
    - Interaction triggers use recognized event names
    - Accessibility section has aria, keyboard, and focus fields
    - Visual mapping has class and data_attributes fields
    - Form components have control section
    - Compound components have composition section
    - All text in English
    - No YAML string "undefined" — use null (~)

  warnings:
    - Components with dependencies should declare them in composition.dependencies
    - Components with size enum should reference shared tokens
    - State definitions should have corresponding interaction triggers
    - States with aria field should have matching accessibility.aria descriptions
    - Visual mapping data_attributes should cover all enum-type attributes

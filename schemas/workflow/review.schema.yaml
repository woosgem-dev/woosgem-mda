# schemas/workflow/review.schema.yaml
# Workflow artifact: structured review findings produced by agents.
# Each phase agent outputs findings; the orchestrator wraps them in this structure.
# Source: docs/plans/2026-02-12-spec-driven-dev-workflow-design.md Section 1
# Applies to: domains/*/*/.reviews/rNN-pN-*.yaml

schema:
  version: 1.0.0
  layer: workflow
  description: Review finding format — the feedback artifact that connects all workflow phases
  applies_to: domains/*/*/.reviews/*.yaml

# ─────────────────────────────────────────────
# SECTION 1: Review Envelope
# ─────────────────────────────────────────────

envelope:
  description: "Top-level fields wrapping findings. Auto-generated by orchestrator."
  fields:
    phase:
      type: enum
      required: true
      values: [spec-review, code-gen, senior-review, qa, parity]
      description: "Which workflow phase produced this review"
    reviewer:
      type: string
      required: true
      description: "Agent identifier (e.g., web-senior, code-reviewer, qa-web)"
    round:
      type: number
      required: true
      description: "Which iteration round of the development loop (1-based)"
      min: 1
      max: 3
    timestamp:
      type: string
      required: true
      format: ISO-8601
      description: "When the review was produced (e.g., 2026-02-12T10:30:00Z)"
    spec_file:
      type: string
      required: true
      description: "Path to the spec file reviewed (e.g., spec.yaml, spec.react.yaml)"
    spec_revision:
      type: number
      required: true
      description: "Which revision of the spec was reviewed"
      min: 1

# ─────────────────────────────────────────────
# SECTION 2: Findings Array
# ─────────────────────────────────────────────

findings:
  type: array
  required: true
  description: "List of issues found during the phase. Agents produce only this list."
  item:
    fields:
      id:
        type: string
        required: true
        format: "F-NNN"
        description: "Finding identifier, auto-assigned by orchestrator"
      severity:
        type: enum
        required: true
        values: [critical, high, medium, low]
        description: |
          critical — blocks progress, must fix before next phase
          high — must fix before QA (Phase 4)
          medium — logged as backlog, does not block
          low — logged as backlog, does not block
      target:
        type: enum
        required: true
        values: [spec, code, spec-framework]
        description: |
          spec — the base spec.yaml needs updating
          code — the generated code needs fixing (spec is fine)
          spec-framework — a framework spec (spec.react.yaml, etc.) needs updating
      target_file:
        type: string
        required: true
        description: "Which file needs changing (e.g., spec.yaml, Button.tsx)"
      section:
        type: string
        required: true
        description: "Dot-notation path to the affected section (e.g., interactions.activate)"
      issue:
        type: string
        required: true
        description: "Clear description of the problem found"
      suggestion:
        type: string
        required: true
        description: "Proposed fix or improvement. Natural language, not a diff."
      resolution:
        type: enum
        required: false
        values: [pending, fixed, deferred, wontfix, reverted]
        default: pending
        description: "How the finding was resolved (updated by orchestrator after resolution)"

# ─────────────────────────────────────────────
# SECTION 3: Naming Convention
# ─────────────────────────────────────────────

naming:
  pattern: "rNN-pN-{phase-name}.yaml"
  examples:
    - r01-p1-spec-review.yaml
    - r01-p2-impl-feedback.yaml
    - r01-p3-senior-review.yaml
    - r01-p4-qa-report.yaml
    - r02-p5-parity-report.yaml
  description: "Round-phase encoding: r{round}-p{phase}-{descriptive-name}.yaml"

# ─────────────────────────────────────────────
# SECTION 4: Processing Rules
# ─────────────────────────────────────────────

rules:
  - "Agents produce only the findings list; orchestrator wraps in envelope"
  - "Finding IDs are auto-assigned by orchestrator (agents must not set them)"
  - "Resolution field is managed by orchestrator, not by the producing agent"
  - "After agent output, orchestrator validates against this schema"
  - "If validation fails: re-prompt agent once, then escalate to human"
  - "Severity determines flow: critical blocks, high accumulates, medium/low go to backlog"

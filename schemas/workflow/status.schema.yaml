# schemas/workflow/status.schema.yaml
# Workflow artifact: per-component lifecycle tracking and quality metrics.
# Maintained by the orchestrator throughout the development cycle.
# Source: docs/plans/2026-02-12-spec-driven-dev-workflow-design.md Section 3
# Applies to: domains/*/*/.status.yaml

schema:
  version: 1.0.0
  layer: workflow
  description: Component status tracking — lifecycle phase, quality metrics, and backlog
  applies_to: domains/*/*/.status.yaml

# ─────────────────────────────────────────────
# SECTION 1: Component Identity
# ─────────────────────────────────────────────

identity:
  fields:
    component: { type: string, required: true, format: PascalCase, description: "Component name" }
    domain: { type: string, required: true, description: "Domain path (e.g., atoms/button)" }

# ─────────────────────────────────────────────
# SECTION 2: Phase Tracking
# ─────────────────────────────────────────────

phase_tracking:
  fields:
    current_phase:
      type: enum
      required: true
      values: [spec-review, code-gen, senior-review, qa, parity, shipped]
      description: "Current phase in the development cycle"
    status:
      type: enum
      required: true
      values: [draft, in-review, failing, passing, shipped, error]
      description: "draft | in-review | failing | passing | shipped | error"
    current_round: { type: number, required: true, min: 1, max: 3, description: "Current iteration round (1-3)" }
    spec_revision: { type: number, required: true, min: 1, description: "Current spec.yaml $revision number" }
    last_good_revision: { type: number, required: false, description: "Last spec revision that passed QA — rollback target" }

# ─────────────────────────────────────────────
# SECTION 3: Unresolved Findings Summary
# ─────────────────────────────────────────────

unresolved:
  description: "Count of unresolved findings by severity"
  fields:
    critical: { type: number, required: true, default: 0 }
    high: { type: number, required: true, default: 0 }
    medium: { type: number, required: true, default: 0 }

# ─────────────────────────────────────────────
# SECTION 4: Framework Status
# ─────────────────────────────────────────────

frameworks:
  type: map
  required: false
  description: "Per-framework generation status. Keys: react, vue, lit."
  value_fields:
    status: { type: enum, values: [pending, generating, review, qa, passed, failed] }
    last_phase_completed: { type: enum, values: [spec-review, code-gen, senior-review, qa, parity] }

# ─────────────────────────────────────────────
# SECTION 5: Backlog
# ─────────────────────────────────────────────

backlog:
  type: array
  required: false
  description: "Deferred medium/low findings that do not block shipping"
  item:
    fields:
      id: { type: string, required: true, description: "Finding ID (e.g., F-003)" }
      source: { type: string, required: true, description: "Review file that produced this finding" }
      section: { type: string, required: true, description: "Spec section affected" }

# ─────────────────────────────────────────────
# SECTION 6: Quality Metrics
# ─────────────────────────────────────────────

quality_metrics:
  required: false
  description: "Populated after QA (Phase 4) completes"
  fields:
    coverage:
      fields:
        line: { type: number, description: "Line coverage percentage" }
        branch: { type: number, description: "Branch coverage percentage" }
    tests:
      fields:
        total: { type: number }
        passed: { type: number }
        failed: { type: number }
        tier1_count: { type: number, description: "Deterministic test count" }
        tier2_count: { type: number, description: "LLM-generated test count" }
    accessibility:
      fields:
        axe_violations: { type: number, description: "axe-core violation count" }
    parity:
      fields:
        structural_pass_rate: { type: number, description: "Parity checks pass rate %" }
    performance:
      fields:
        render_time_ms: { type: map, description: "Per-framework render time in ms" }
        bundle_size_kb: { type: map, description: "Per-framework bundle size in KB" }

# ─────────────────────────────────────────────
# SECTION 7: History
# ─────────────────────────────────────────────

history:
  type: array
  required: false
  description: "Record of completed rounds for audit trail"
  item:
    fields:
      round: { type: number, required: true }
      spec_changes: { type: number, required: true, description: "Spec revisions in this round" }
      code_fixes: { type: number, required: true, description: "Code fixes in this round" }
      duration_minutes: { type: number, required: false, description: "Wall-clock time for the round" }
